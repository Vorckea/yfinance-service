name: Deploy on Release

inputs:
  release_tag:
    type: string
    description: "The release tag to deploy"
    required: true
  release_name:
    type: string
    description: "The release name"
    required: true
  github_token:
    type: string
    description: "GitHub token (pass secrets.GITHUB_TOKEN from the workflow)"
    required: true

timeout-minutes: 30

environment:
  name: production

runs:
  using: "composite"
  steps:
    - name: Set up environment variables
      shell: bash
      run: |
        echo "IMAGE_NAME=ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}" >> $GITHUB_ENV
        echo "TAG=${{ inputs.release_tag }}" >> $GITHUB_ENV
    
    - name: Verify release tag is semver
      id: verify_tag
      shell: bash
      run: |
        TAG="${{ inputs.release_tag }}"
        echo "Release tag: $TAG"
        if ! echo "$TAG" | grep -Eq '^v?(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)(-([0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*))?(\+([0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*))?$'; then
          echo "âŒ Release tag is not semver (expected v1.2.3 or 1.2.3). Aborting."
          exit 1
        fi

    - name: Setup QEMU
      uses: docker/setup-qemu-action@v3

    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ inputs.github_token }}

    - name: Check if stable release
      id: check_stable
      shell: bash
      run: |
        TAG="${{ inputs.release_tag }}"
        if [[ "$TAG" == *"-"* ]]; then
          echo "is_stable=false" >> $GITHUB_OUTPUT
        else
          echo "is_stable=true" >> $GITHUB_OUTPUT
        fi

    - name: Extract release version
      id: extract_version
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.IMAGE_NAME }}
        github-token: ${{ inputs.github_token }}
        tags: |
          type=semver,pattern={{version}},value=${{ inputs.release_tag }}
          type=semver,pattern={{major}}.{{minor}},value=${{ inputs.release_tag }}
          type=semver,pattern={{major}},value=${{ inputs.release_tag }}
          type=raw,value=latest,enable=${{ steps.check_stable.outputs.is_stable }}


    - name: Build and Push Docker Image
      id: push
      uses: docker/build-push-action@v6
      with:
        context: .  
        file: ./Dockerfile
        push: true
        platforms: linux/amd64,linux/arm64
        tags: ${{ steps.extract_version.outputs.tags }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Generate SBOM
      uses: anchore/sbom-action@v0
      with:
        image: ${{ env.IMAGE_NAME }}@${{ steps.push.outputs.digest }}
        format: cyclonedx
        output-file: sbom.cyclonedx.json

    - name: Upload SBOM as artifact
      uses: actions/upload-artifact@v4
      with:
        name: sbom-cyclonedx
        path: sbom.cyclonedx.json

    - name: Generate artifact attestation
      uses: actions/attest-build-provenance@v3
      with:
        subject-name: ${{ env.IMAGE_NAME }}
        subject-digest: ${{ steps.push.outputs.digest }}
        push-to-registry: true

    - name: Scan image with Trivy (vuln check)
      uses: aquasecurity/trivy-action@0.33.1
      with:
        image-ref: ${{ env.IMAGE_NAME }}@${{ steps.push.outputs.digest }}
        format: "table"
        exit-code: "1"
        ignore-unfixed: true
        vuln-type: "os,library"
        severity: "HIGH,CRITICAL"

    # Removed manual cache move step as it is not needed with type=gha
